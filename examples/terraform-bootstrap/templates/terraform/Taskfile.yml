version: "3"

tasks:
  tf-state-init:
    cmds:
      - terraform init
      - terraform workspace {{ `{{.CLI_ARGS}}` }}
      - terraform apply -target local_file.backend_config -y
      - echo "access_key=$(az storage account keys list --resource-group {{ .Variables.RESOURCE_GROUP_NAME }} --account-name $(terraform output -raw tfstate_storage_account_name) --query '[0].value' --output tsv)" > terraform-backend.config
      - terraform init -migrate-state -backend-config="key=dev.tfstate" -backend-config="terraform-backend.config"
